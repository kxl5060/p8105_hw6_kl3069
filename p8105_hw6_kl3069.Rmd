---
title: "P8105 Homework 6"
author: "Kyung Suk Lee"
date: "`r Sys.Date()`"
output: 
  github_document:
    toc: yes
---

```{r setup, include=FALSE}
library(tidyverse)
library(modelr)
library(mgcv)
library(p8105.datasets)

knitr::opts_chunk$set(out.width = "100%")

theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis")

scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d

knitr::opts_chunk$set(comment = NA, message = FALSE, warning = FALSE, echo = TRUE)
```

## Problem 1

```{r}
homicide_df = 
  read_csv("./data/homicide-data.csv", na = c("", "NA", "Unknown")) %>%
  janitor::clean_names() %>% 
  mutate(
    city_state = str_c(city, state, sep = ", "),
    victim_age = as.numeric(victim_age),
    resolution = case_when(
      disposition == "Closed without arrest" ~ 0,
      disposition == "Open/No arrest"        ~ 0,
      disposition == "Closed by arrest"      ~ 1
  )) %>% 
  filter(!(city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL")),
         victim_race %in% c("White", "Black")) %>% 
  select(city_state, resolution, victim_age, victim_race, victim_sex)
```

```{r}
baltimore_df = 
  homicide_df %>% 
  filter(city_state == "Baltimore, MD")

glm(resolution ~ victim_age + victim_race + victim_sex,
    data = baltimore_df, family = binomial()) %>% 
  broom::tidy() %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96*std.error),
    CI_upper = exp(estimate + 1.96*std.error)
  ) %>% 
  select(term, OR, starts_with("CI")) %>% 
  knitr::kable(digits = 3,
               format = "html",
               caption = "Table: Estimate and confidence interval of the adjusted odds ratio")
```

```{r}
models_results_df = 
  homicide_df %>% 
    nest(data = -city_state) %>% 
    mutate(
      models = map(.x = data, ~glm(resolution ~ victim_age + victim_race + victim_sex,
                                   data = .x,
                                   family = binomial())),
      results = map(models, broom::tidy)
    ) %>% 
    select(city_state, results) %>% 
    unnest(results) %>% 
    mutate(
      OR = exp(estimate),
      CI_lower = exp(estimate - 1.96*std.error),
      CI_upper = exp(estimate + 1.96*std.error)
    ) %>% 
    select(city_state, term, OR, starts_with("CI"))
```

```{r}
models_results_df %>% 
  filter(term == "victim_raceWhite") %>% 
  mutate(city_state = fct_reorder(city_state, OR)) %>% 
  ggplot(aes(x = city_state, y = OR, color = city_state))+
  geom_point()+
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper))+
  theme(axis.text.y = element_text(size = 6), legend.position = "none") +
  labs(
    title = "Odds Ratio by Cities",
    x = "City",
    y = "Odds Ratio",
    caption = "Datasource: The Washington Post",
    color = "") +
  theme(plot.title = element_text(face="bold",
                                  hjust=0.5,
                                  lineheight=1.2)) +
  scale_y_continuous(breaks = seq(0, 30, by = 1)) +
  coord_flip()
```

* **Comment on the plot**: The above plot illustrates that for most cities the estimates for odds ratio are above 1.0. Such result indicates that more homicides are likely to be solved for white compared to non-whites. We can observe that this is more apparent in cities such as Boston, Omaha, Oakland, and Pittsburgh.

## Problem 2

```{r}
birthweight = 
  read_csv("./data/birthweight.csv") %>% 
  janitor::clean_names() %>% 
  mutate(babysex = as.factor(babysex),
         frace = as.factor(frace),
         malform = as.factor(malform),
         mrace = as.factor(mrace),
         babysex = recode(babysex, 
                          "1" = "male", 
                          "2" = "female"),
         frace = recode(frace, 
                        "1" = "white", 
                        "2" = "black", 
                        "3" = "asian", 
                        "4" = "puerto rican", 
                        "8" = "other"),
         malform = recode(malform, 
                          "0" = "absent", 
                          "1" = "present"),
         mrace = recode(mrace, 
                        "1" = "white", 
                        "2" = "black", 
                        "3" = "asian", 
                        "4" = "puerto rican"))

birthweight %>% 
  is.na() %>% 
  summary()
```

* **Comment on the cleaned dataset**: As can be seen above, I have loaded and cleaned the initial data for regression analysis by converting numeric to factor where appropriate. Also I have checked for missing data and there seems to be none.

```{r}
initial_model = lm(bwt ~ ., data = birthweight)

fitted_model = step(initial_model, direction = "backward")
  
fitted_model %>% summary()
```

* **Comment on the modeling process**: As can be seen above, I have performed a stepwise regression. The stepwise regression carry out adding and removing predictors, in the predictive model, in order to find the subset of variables in the data set that results the best performing model. As can be seen from the summary, the best performing model consists of 13 predictors.

```{r}
birthweight %>% 
  add_predictions(., fitted_model) %>% 
  add_residuals(., fitted_model) %>%
  ggplot(aes(x = pred, y = resid)) +
  geom_point(alpha = .3) +
  labs(
    title = "Plot of model residuals against fitted values",
    x = "Fitted (Predicted) Values",
    y = "Residuals",
    caption = "Datasource: birthweight.csv",
    color = "") +
  theme(plot.title = element_text(face="bold",
                                  hjust=0.5,
                                  lineheight=1.2))
```

* **Comment on the plot**: As can be seen above, the values are heavily concentrated between 2500 and 3500 for fitted values and between -500 and 500 for residuals.

```{r}
# One using length at birth and gestational age as predictors (main effects only)
comparison_model_1 = lm(bwt ~ blength + gaweeks, data = birthweight)

summary(comparison_model_1)

# One using head circumference, length, sex, and all interactions (including the three-way interaction)
comparison_model_2 = lm(bwt ~ bhead + blength + babysex
                        + bhead*blength + bhead*babysex + blength*babysex
                        + bhead*blength*babysex, data = birthweight)

summary(comparison_model_2)
```

```{r}
birthweight_cv = 
  crossv_mc(birthweight, 100) %>% 
  mutate(
    train = map(train, as_tibble),
    test  = map(test, as_tibble))

birthweight_cv = 
  birthweight_cv %>% 
  mutate(
    best_fitted = map(train, ~lm(bwt ~ babysex + bhead + blength + delwt + fincome + gaweeks 
                                       + mheight + mrace + parity + ppwt + smoken, data = .x)),
    comparison_1 = map(train, ~lm(bwt ~ blength + gaweeks, data = .x)),
    comparison_2 = map(train, ~lm(bwt ~ bhead + blength + babysex 
                        + bhead*blength + bhead*babysex + blength*babysex 
                        + bhead*blength*babysex, data = .x))) %>%
  mutate(
    rmse_best_fitted = map2_dbl(best_fitted, test, ~rmse(model = .x, data = .y)),
    rmse_comparison_1 = map2_dbl(comparison_1, test, ~rmse(model = .x, data = .y)),
    rmse_comparison_2 = map2_dbl(comparison_2, test, ~rmse(model = .x, data = .y))
  )
```

```{r}
birthweight_cv %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model",
    values_to = "rmse",
    names_prefix = "rmse_"
  ) %>% 
  mutate(model = recode(model, best_fitted = "Best Performing Model", 
                        comparison_1 = "Main Effect Model",
                        comparison_2 = "Three-way Interaction Model"),
         model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse, fill = model)) + 
  geom_violin() +
  stat_summary(fun.data = "mean_sdl",
               fun.args = list(mult = 1), 
               geom = "pointrange", 
               color = "red") +
  labs(
    title = "RMSE comparison by each model",
    x = "Model",
    y = "RMSE",
    caption = "Datasource: birthweight.csv",
    fill = "") +
  theme(plot.title = element_text(face="bold",
                                  hjust=0.5,
                                  lineheight=1.2)) +
  theme(legend.position = "none")
```

* **Comment on the plot**: As can be seen above, from the violin plot, the model (Best Performing Model) that used stepwise regression seemed to have the lowest RMSE distribution compared to other two comparison models (Main Effect Model and Three-way Interaction Model). The plot illustrates that the prediction accuracy of the model takes into account the magnitude of complexity of the model.

## Problem 3

























